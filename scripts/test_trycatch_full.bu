// ==========================================
// TESTES COMPLETOS DE TRY/CATCH
// ==========================================

var tests_passed = 0;
var tests_failed = 0;

def assert_eq(name, expected, actual) {
    if (expected == actual) {
        tests_passed++;
        print("[PASS] " + name);
    } else {
        tests_failed++;
        write("[FAIL] {}: expected {}, got {}\n", name, expected, actual);
    }
}

def assert_true(name, condition) {
    if (condition) {
        tests_passed++;
        print("[PASS] " + name);
    } else {
        tests_failed++;
        print("[FAIL] " + name);
    }
}

print("========================================");
print("   TRY/CATCH TESTS");
print("========================================");


// ==========================================
// TESTE 1: Try sem erro (código normal)
// ==========================================
print("\n--- TESTE 1: Try sem erro ---");

var t1_try = false;
var t1_catch = false;

try {
    t1_try = true;
    var x = 10 + 20;
} catch (e) {
    t1_catch = true;
}

assert_true("Try block executed", t1_try);
assert_true("Catch skipped on success", !t1_catch);


// ==========================================
// TESTE 2: Divisão por zero
// ==========================================
print("\n--- TESTE 2: Divisão por zero ---");

var t2_before = false;
var t2_after = false;
var t2_catch = false;
var t2_error = "";

try {
    t2_before = true;
    var x = 10 / 0;  // ERRO!
    t2_after = true;  // Nunca atinge
} catch (e) {
    t2_catch = true;
    t2_error = e;
}

assert_true("Code before error ran", t2_before);
assert_true("Code after error skipped", !t2_after);
assert_true("Catch executed", t2_catch);


// ==========================================
// TESTE 3: Type error (string * number)
// ==========================================
print("\n--- TESTE 3: Type error ---");

var t3_catch = false;

try {
    var s = "texto";
    var n = s * 5;  // ERRO!
} catch (e) {
    t3_catch = true;
}

assert_true("Type error caught", t3_catch);


// ==========================================
// TESTE 4: Operação com nil
// ==========================================
print("\n--- TESTE 4: Operação com nil ---");

var t4_catch = false;

try {
    var n = nil;
    var x = n + 10;  // ERRO!
} catch (e) {
    t4_catch = true;
}

assert_true("Nil operation caught", t4_catch);


// ==========================================
// TESTE 5: VM continua após catch
// ==========================================
print("\n--- TESTE 5: VM continua após catch ---");

var t5_value = 0;

try {
    var boom = 10 / 0;
} catch (e) {
    // Recupera
}

t5_value = 100;
assert_eq("VM continues", 100, t5_value);


// ==========================================
// TESTE 6: Try/catch nested
// ==========================================
print("\n--- TESTE 6: Try/catch nested ---");

var t6_outer = false;
var t6_inner = false;

try {
    try {
        var x = 10 / 0;
    } catch (e) {
        t6_inner = true;
    }
    t6_outer = true;  // Deve executar após inner catch
} catch (e) {
    // Não deve chegar aqui
}

assert_true("Inner catch executed", t6_inner);
assert_true("Outer try continued", t6_outer);


// ==========================================
// TESTE 7: Rethrow (throw manual)
// ==========================================
print("\n--- TESTE 7: Throw manual ---");

var t7_catch = false;
var t7_error = "";

try {
    throw "Erro customizado!";
} catch (e) {
    t7_catch = true;
    t7_error = e;
}

assert_true("Manual throw caught", t7_catch);
assert_eq("Error message", "Erro customizado!", t7_error);


// ==========================================
// TESTE 8: Try/catch em função
// ==========================================
print("\n--- TESTE 8: Try/catch em função ---");

var t8_result = 0;

def safeDivide(a, b) {
    try {
        return a / b;
    } catch (e) {
        return -1;
    }
}

t8_result = safeDivide(10, 2);
assert_eq("Safe divide success", 5, t8_result);

t8_result = safeDivide(10, 0);
assert_eq("Safe divide error", -1, t8_result);


// ==========================================
// TESTE 9: Try/catch com finally
// ==========================================
print("\n--- TESTE 9: Finally ---");

var t9_try = false;
var t9_catch = false;
var t9_finally = false;

try {
    t9_try = true;
    var x = 10 / 0;
} catch (e) {
    t9_catch = true;
} finally {
    t9_finally = true;
}

assert_true("Try ran before error", t9_try);
assert_true("Catch ran", t9_catch);
assert_true("Finally ran", t9_finally);


// ==========================================
// TESTE 10: Finally sem erro
// ==========================================
print("\n--- TESTE 10: Finally sem erro ---");

var t10_finally = false;

try {
    var x = 10 + 20;
} catch (e) {
    // Não atinge
} finally {
    t10_finally = true;
}

assert_true("Finally runs on success", t10_finally);


// ==========================================
// TESTE 11: Return dentro de try
// ==========================================
print("\n--- TESTE 11: Return dentro de try ---");

var t11_finally = false;

def returnInTry() {
    try {
        return 42;
    } finally {
        t11_finally = true;
    }
}

var t11_result = returnInTry();
assert_eq("Return value preserved", 42, t11_result);
assert_true("Finally ran before return", t11_finally);


// ==========================================
// TESTE 12: Array index out of bounds
// ==========================================
print("\n--- TESTE 12: Array out of bounds ---");

var t12_catch = false;

try {
    var arr = [1, 2, 3];
    var x = arr[100];  // Out of bounds
} catch (e) {
    t12_catch = true;
}

assert_true("Array bounds error caught", t12_catch);


// ==========================================
// TESTE 13: Map key não existe
// ==========================================
print("\n--- TESTE 13: Map key missing ---");

var t13_result = nil;

try {
    var m = {"a": 1};
    t13_result = m["nonexistent"];
} catch (e) {
    t13_result = "error";
}

// Nota: Pode retornar nil em vez de erro
print("   Map missing key result: " + str(t13_result));


// ==========================================
// TESTE 14: Try/catch em loop
// ==========================================
print("\n--- TESTE 14: Try/catch em loop ---");

var t14_errors = 0;
var t14_successes = 0;

var i = 0;
while (i < 5) {
    try {
        if (i == 2) {
            throw "Erro no índice 2";
        }
        t14_successes++;
    } catch (e) {
        t14_errors++;
    }
    i++;
}

assert_eq("Loop successes", 4, t14_successes);
assert_eq("Loop errors", 1, t14_errors);


// ==========================================
// TESTE 15: Undefined variable
// ==========================================
print("\n--- TESTE 15: Undefined variable ---");

var t15_catch = false;

// Nota: Isto pode ser erro de compilação, não runtime
// Vamos testar diferente
try {
    var obj = nil;
    var x = obj.field;  // Acesso a campo de nil
} catch (e) {
    t15_catch = true;
}

assert_true("Nil field access caught", t15_catch);


// ==========================================
// RESUMO
// ==========================================
print("");
print("========================================");
write("TRY/CATCH TESTS: {} passed, {} failed\n", tests_passed, tests_failed);
print("========================================");
