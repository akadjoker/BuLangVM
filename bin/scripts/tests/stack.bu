
print("A iniciar teste de tortura...");

var counter = 0;

// Vamos forçar 1 milhão de loops com breaks
// Se houver desalinhamento de stack de 1 byte que seja, isto REBENTA.
while (counter < 1000000) 
{
    
    var dummy = 10; // Suja a stack com uma variável local
    
    while (true) 
    {
        var inner = 20; // Suja mais
        break; // O momento da verdade: limpa 'inner', salta o POP do 'true'?
        print("Isto nunca deve aparecer");
    }

    // Se o break falhou a limpeza, a stack aqui estaria corrompida 
    // e o próximo uso de 'counter' daria erro.
    counter = counter + 1;
}

print("SUCESSO! A stack sobreviveu a 1 milhão de breaks.");



print("=== INICIO TESTE DO-WHILE ===");

// ---------------------------------------------------------
// TESTE 1: Continue
// O 'continue' deve saltar para a verificação da condição (i < 5),
// e NÃO para o topo do bloco (o que repetiria o print "Inicio" infinitamente se a lógica estivesse errada).
// ---------------------------------------------------------
print(">> Teste 1: Continue");
var i = 0;

do
{
    i = i + 1;
    
    if (i == 3)
    {
        print("   -> (i é 3) Continue... saltando o print de baixo");
        continue; 
    }
    
    print("   Valor de i: " + i);
    
} while (i < 5);


// ---------------------------------------------------------
// TESTE 2: Break
// O break deve sair imediatamente. Como no do-while a condição
// ainda não foi colocada na stack dentro do corpo, o break é "limpo".
// ---------------------------------------------------------
print("\n>> Teste 2: Break");
var j = 0;

do
{
    j = j + 1;
    print("   Loop J: " + j);
    
    if (j == 2)
    {
        print("   -> (j é 2) Break! Saindo...");
        break;
    }
    
    print("   (Este print não deve aparecer quando J for 2)");
    
} while (true); // Loop infinito se o break falhar


print("\n=== FIM DO TESTE (SUCESSO) ===");


print("=== INICIO TORTURE TEST V2 (AGORA COM SWITCH) ===");

var counter = 0;

// Vamos puxar mais pelo sistema: 1 milhão de iterações
while (counter < 1000000)
{
    
    // ----------------------------------------------------
    // CENÁRIO: Switch dentro de Loop
    // O 'break' dentro do case deve limpar:
    // 1. O valor do switch na stack
    // 2. O escopo do while(true)
    // ----------------------------------------------------
    while (true)
    {
        var trigger = 1;
        
        switch (trigger)
        {
            case 0:
                print("Nunca entra aqui");
            case 1:
                // Este break vai sair do 'while(true)'
                // Se a stack do switch não for limpa antes disto,
                // vamos acumular lixo e explodir a stack em poucas iterações.
                break; 
            default:
                print("Nem aqui");
        }
        
        // Se o break funcionou mal, este print apareceria
        print("ERRO: O break não saiu do loop!");
        // Forçar saída para não bloquear o teste se falhar
        
    }

    // Validação de sanidade
    counter = counter + 1;
    
    // Feedback visual a cada 100k para saberes que está vivo
    if (counter == 250000) { print("25%..."); }
    if (counter == 500000) { print("50%..."); }
    if (counter == 750000) { print("75%..."); }
}


print("SUCESSO ABSOLUTO! Stack sobreviveu a Switch + Break.");


print("Teste de Leak ++i");
var i = 0;
while (i < 1000000) 
{
    ++i; // Se isto deixar lixo, a stack explode aqui
}
print("Sucesso!");
